# USB OTG Binary Protocol

–ë–∏–Ω–∞—Ä–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è ESP32-S2 —Å Android/PC —á–µ—Ä–µ–∑ USB CDC.

## –§–æ—Ä–º–∞—Ç –ø–∞–∫–µ—Ç–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Magic (2) ‚îÇ Type (1) ‚îÇ Length (2) ‚îÇ Payload ‚îÇ CRC16 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   0xAA55     1 byte     uint16 LE    N bytes   uint16 LE

Overhead: 7 –±–∞–π—Ç
CRC: CRC16-CCITT (polynomial 0x1021)
```

## –¢–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π

### ESP32 ‚Üí Host (0x01-0x7F)

| Type | –ù–∞–∑–≤–∞–Ω–∏–µ | Payload | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|---------|----------|
| `0x01` | TEXT_MESSAGE | string | –¢–µ–∫—Å—Ç–æ–≤—ã–µ –ª–æ–≥–∏, warnings |
| `0x02` | ADC_DATA | int16[] | ADC –±—É—Ñ–µ—Ä (40000 samples) |
| `0x03` | STATUS | struct | –°—Ç–∞—Ç—É—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ |
| `0x04` | ACK | empty | –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã |
| `0x05` | ERROR | string | –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è |

### Host ‚Üí ESP32 (0x80-0xFF)

| Type | –ù–∞–∑–≤–∞–Ω–∏–µ | Payload | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|---------|----------|
| `0x81` | SET_POT | uint8 (0-99) | –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–æ–º–µ—Ç—Ä |
| `0x87` | GET_POT | empty | –ü–æ–ª—É—á–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –ø–æ—Ç–µ–Ω—Ü–∏–æ–º–µ—Ç—Ä–∞ |
| `0x82` | GET_ADC | empty | –ó–∞–ø—Ä–æ—Å–∏—Ç—å ADC –±—É—Ñ–µ—Ä |
| `0x83` | SET_DAC | int16[] mono + name | –ó–∞–≥—Ä—É–∑–∏—Ç—å DAC –±—É—Ñ–µ—Ä (–ú–û–ù–û + –∏–º—è –ø—Ä–µ—Å–µ—Ç–∞) |
| `0x84` | SET_PARAMS | TBD | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã (freq, amp) |
| `0x85` | GET_STATUS | empty | –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç—É—Å |
| `0x86` | RESET | empty | –°–±—Ä–æ—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ |

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ STATUS

```c
struct DeviceStatus {
  uint8_t pot_position;   // –ü–æ–∑–∏—Ü–∏—è –ø–æ—Ç–µ–Ω—Ü–∏–æ–º–µ—Ç—Ä–∞ (0-99)
  uint32_t adc_samples;   // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö ADC —Å—ç–º–ø–ª–æ–≤
  uint16_t adc_rate;      // –ß–∞—Å—Ç–æ—Ç–∞ ADC (Hz)
  uint8_t error_flags;    // –§–ª–∞–≥–∏ –æ—à–∏–±–æ–∫
  // –ü–æ—Å–ª–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏–¥—ë—Ç —Å—Ç—Ä–æ–∫–∞ –∏–º–µ–Ω–∏ –ø—Ä–µ—Å–µ—Ç–∞ (–ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–ª–∏–Ω—ã)
} __attribute__((packed));

–†–∞–∑–º–µ—Ä: 8 –±–∞–π—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π + preset_name (–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª–∏–Ω–∞)
```

**–§–æ—Ä–º–∞—Ç payload:**
```
[DeviceStatus: 8 bytes] [preset_name: string –¥–æ –∫–æ–Ω—Ü–∞ –ø–∞–∫–µ—Ç–∞]
```

**–ü—Ä–∏–º–µ—Ä preset_name:**
- `"tACS 640Hz 1mA demo"`
- `"tRNS 100-640 normal 1mA"`
- `"tDCS 1mA"`

## –ü—Ä–∏–º–µ—Ä—ã –ø–∞–∫–µ—Ç–æ–≤

### 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–æ–º–µ—Ç—Ä –Ω–∞ 75

**–û—Ç–ø—Ä–∞–≤–∫–∞ (Host ‚Üí ESP32):**
```
AA 55          # Magic
81             # CMD_SET_POT
01 00          # Length = 1
4B             # Payload: 75
XX XX          # CRC16
```

**–û—Ç–≤–µ—Ç (ESP32 ‚Üí Host):**
```
AA 55          # Magic
04             # MSG_ACK
00 00          # Length = 0
XX XX          # CRC16
```

### 2. –ü–æ–ª—É—á–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –ø–æ—Ç–µ–Ω—Ü–∏–æ–º–µ—Ç—Ä–∞

**–û—Ç–ø—Ä–∞–≤–∫–∞ (Host ‚Üí ESP32):**
```
AA 55          # Magic
87             # CMD_GET_POT
00 00          # Length = 0
XX XX          # CRC16
```

**–û—Ç–≤–µ—Ç (ESP32 ‚Üí Host):**
```
AA 55          # Magic
04             # MSG_ACK
01 00          # Length = 1
4B             # Payload: 75 (–ø–æ–∑–∏—Ü–∏—è)
XX XX          # CRC16
```

### 3. –ó–∞–ø—Ä–æ—Å–∏—Ç—å ADC –±—É—Ñ–µ—Ä

**–û—Ç–ø—Ä–∞–≤–∫–∞:**
```
AA 55          # Magic
82             # CMD_GET_ADC
00 00          # Length = 0
XX XX          # CRC16
```

**–û—Ç–≤–µ—Ç:**
```
AA 55          # Magic
02             # MSG_ADC_DATA
40 9C          # Length = 40000 (0x9C40)
[80KB data]    # 40000 √ó int16
XX XX          # CRC16
```

### 4. –ó–∞–≥—Ä—É–∑–∏—Ç—å DAC –±—É—Ñ–µ—Ä (–ø—Ä–µ—Å–µ—Ç)

**–û—Ç–ø—Ä–∞–≤–∫–∞:**
```
AA 55                      # Magic
83                         # CMD_SET_DAC
2C 7D                      # Length = 32012 (0x7D2C)
                           #   = 32000 bytes MONO + 12 bytes name
[32000 bytes]              # int16[] MONO (16000 samples)
"tACS 640Hz\0"             # Preset name (null-terminated)
XX XX                      # CRC16
```

**–§–æ—Ä–º–∞—Ç payload:**
```
[int16_t buffer[SIGNAL_SAMPLES]] + [char preset_name[]]
  ^--- –ú–û–ù–û (—Ç–æ–ª—å–∫–æ –ø—Ä–∞–≤—ã–π –∫–∞–Ω–∞–ª)    ^--- –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª–∏–Ω–∞
  32000 bytes (16000 samples)
```

**–í–∞–∂–Ω–æ:** –õ–µ–≤—ã–π –∫–∞–Ω–∞–ª = –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ (-0.5V), –Ω–µ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è!

### 5. –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–ª–æ–≥)

**ESP32 ‚Üí Host:**
```
AA 55               # Magic
01                  # MSG_TEXT
10 00               # Length = 16
"WARN: test\n"      # Payload
XX XX               # CRC16
```

## Python –ø—Ä–∏–º–µ—Ä

```python
from test_device import tRNSDevice
import numpy as np

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
dev = tRNSDevice('/dev/ttyACM0')

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–æ–º–µ—Ç—Ä
dev.set_pot(50)

# –ü–æ–ª—É—á–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –ø–æ—Ç–µ–Ω—Ü–∏–æ–º–µ—Ç—Ä–∞
position = dev.get_pot_position()
print(f"Pot: {position}")

# –ü–æ–ª—É—á–∏—Ç—å ADC –¥–∞–Ω–Ω—ã–µ
adc_data = dev.get_adc_data()

# –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å (—Å –∏–º–µ–Ω–µ–º –ø—Ä–µ—Å–µ—Ç–∞)
status = dev.get_status()
print(f"Preset: {status['preset_name']}")
print(f"Pot: {status['pot_position']}")

# –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–µ—Å–µ—Ç (–ú–û–ù–û –±—É—Ñ–µ—Ä + –∏–º—è)
buffer = np.sin(2 * np.pi * 640 * np.arange(16000) / 8000)
buffer = (buffer * 10000).astype(np.int16)  # –ú–û–ù–û!
dev.upload_dac_buffer(buffer, "tACS 640Hz custom")
```

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- **–ë–∏–Ω–∞—Ä–Ω—ã–π** - —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö (80 KB ADC)
- **Magic bytes** - –Ω–∞–¥—ë–∂–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- **CRC16** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
- **–ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–π** - –Ω–µ –º–µ—à–∞–µ—Ç —Ä–∞–±–æ—Ç–µ DMA –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
- **–ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥** - state machine –¥–ª—è –ø—Ä–∏—ë–º–∞
- **–ß–∏—Ç–∞–µ–º—ã–µ –ª–æ–≥–∏** - —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞

### üéØ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- –°–∫–æ—Ä–æ—Å—Ç—å: **921600 baud** ‚âà 92 KB/s —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏
- ADC –±—É—Ñ–µ—Ä (80 KB): **~1 —Å–µ–∫—É–Ω–¥–∞** –ø–µ—Ä–µ–¥–∞—á–∏
- DAC –±—É—Ñ–µ—Ä –ú–û–ù–û (32 KB): **~350 –º—Å** –ø–µ—Ä–µ–¥–∞—á–∏ (–≤–º–µ—Å—Ç–æ 700 –º—Å –¥–ª—è —Å—Ç–µ—Ä–µ–æ!)
- DMA –±—É—Ñ–µ—Ä DAC: **2 —Å–µ–∫** –∑–≤—É–∫–∞ ‚Üí —É—Å–ø–µ–≤–∞–µ—Ç —Å –∑–∞–ø–∞—Å–æ–º!
- –ö–æ–º–∞–Ω–¥—ã: **< 1 –º—Å** (–º–∞–ª—ã–µ –ø–∞–∫–µ—Ç—ã)

**–≠–∫–æ–Ω–æ–º–∏—è:** DAC –ø–µ—Ä–µ–¥–∞—á–∞ **x2 –±—ã—Å—Ç—Ä–µ–µ** (32KB –≤–º–µ—Å—Ç–æ 64KB), —Ç.–∫. –ª–µ–≤—ã–π –∫–∞–Ω–∞–ª = –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞

### üîß Android —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

–î–ª—è Android –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É:
```gradle
implementation 'com.github.mik3y:usb-serial-for-android:3.5.1'
```

–ü—Ä–æ—Ç–æ–∫–æ–ª –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–π - —Ç–µ –∂–µ magic bytes, CRC16, —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.

## –§–∞–π–ª—ã

- `protocol.h/cpp` - –±–∞–∑–æ–≤—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª (–ø–∞—Ä—Å–∏–Ω–≥, CRC)
- `usb_commands.h/cpp` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- `test_device.py` - Python –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

