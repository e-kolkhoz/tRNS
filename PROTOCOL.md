# USB OTG Binary Protocol

–ë–∏–Ω–∞—Ä–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è ESP32-S2 —Å Android/PC —á–µ—Ä–µ–∑ USB CDC.

## –§–æ—Ä–º–∞—Ç –ø–∞–∫–µ—Ç–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Magic (2) ‚îÇ Type (1) ‚îÇ Length (4) ‚îÇ Payload ‚îÇ CRC16 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   0xAA55     1 byte     uint32 LE    N bytes   uint16 LE

Overhead: 9 –±–∞–π—Ç
CRC: CRC16-CCITT (polynomial 0x1021)
Max payload: 4 GB (–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)
```

## –¢–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π

### ESP32 ‚Üí Host (0x01-0x7F)

| Type | –ù–∞–∑–≤–∞–Ω–∏–µ | Payload | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|---------|----------|
| `0x01` | TEXT_MESSAGE | string | –¢–µ–∫—Å—Ç–æ–≤—ã–µ –ª–æ–≥–∏, warnings |
| `0x02` | ADC_DATA | int16[] | ADC –±—É—Ñ–µ—Ä (40960 samples @ 20kHz = 2.048 —Å–µ–∫) |
| `0x03` | STATUS | struct | –°—Ç–∞—Ç—É—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ |
| `0x04` | ACK | empty | –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã |
| `0x05` | ERROR | string | –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è |

### Host ‚Üí ESP32 (0x80-0xFF)

| Type | –ù–∞–∑–≤–∞–Ω–∏–µ | Payload | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|---------|----------|
| `0x82` | GET_ADC | empty | –ó–∞–ø—Ä–æ—Å–∏—Ç—å ADC –±—É—Ñ–µ—Ä |
| `0x83` | SET_DAC | int16[] mono + name | –ó–∞–≥—Ä—É–∑–∏—Ç—å DAC –±—É—Ñ–µ—Ä (–ú–û–ù–û + –∏–º—è –ø—Ä–µ—Å–µ—Ç–∞) |
| `0x84` | SET_PARAMS | TBD | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã (freq, amp) |
| `0x85` | GET_STATUS | empty | –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç—É—Å |
| `0x86` | RESET | empty | –°–±—Ä–æ—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ |
| `0x88` | SET_GAIN | float32 | –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Å–∏–ª–µ–Ω–∏—è (gain ‚â• 0.0) |
| `0x89` | GET_GAIN | empty | –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π gain (response: float32) |

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ STATUS

```c
struct DeviceStatus {
  uint32_t adc_samples;   // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö ADC —Å—ç–º–ø–ª–æ–≤
  uint16_t adc_rate;      // –ß–∞—Å—Ç–æ—Ç–∞ ADC (Hz)
  float gain;             // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Å–∏–ª–µ–Ω–∏—è (gain)
  uint8_t error_flags;    // –§–ª–∞–≥–∏ –æ—à–∏–±–æ–∫
  // –ü–æ—Å–ª–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏–¥—ë—Ç —Å—Ç—Ä–æ–∫–∞ –∏–º–µ–Ω–∏ –ø—Ä–µ—Å–µ—Ç–∞ (–ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–ª–∏–Ω—ã)
} __attribute__((packed));

–†–∞–∑–º–µ—Ä: 11 –±–∞–π—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π + preset_name (–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª–∏–Ω–∞)
```

**–§–æ—Ä–º–∞—Ç payload:**
```
[DeviceStatus: 11 bytes] [preset_name: string –¥–æ –∫–æ–Ω—Ü–∞ –ø–∞–∫–µ—Ç–∞]
```

**–ü—Ä–∏–º–µ—Ä preset_name:**
- `"tACS 640Hz 1mA demo"`
- `"tRNS 100-640 normal 1mA"`
- `"tDCS 1mA"`

## –ü—Ä–∏–º–µ—Ä—ã –ø–∞–∫–µ—Ç–æ–≤

### 1. –ó–∞–ø—Ä–æ—Å–∏—Ç—å ADC –±—É—Ñ–µ—Ä

**–û—Ç–ø—Ä–∞–≤–∫–∞:**
```
AA 55                # Magic
82                   # CMD_GET_ADC
00 00 00 00          # Length = 0 (uint32)
XX XX                # CRC16
```

**–û—Ç–≤–µ—Ç:**
```
AA 55                # Magic
02                   # MSG_ADC_DATA
00 A0 00 00          # Length = 40960 (0xA000, uint32)
[81920 bytes data]   # 40960 √ó int16
XX XX                # CRC16
```

### 2. –ó–∞–≥—Ä—É–∑–∏—Ç—å DAC –±—É—Ñ–µ—Ä (–ø—Ä–µ—Å–µ—Ç)

**–û—Ç–ø—Ä–∞–≤–∫–∞:**
```
AA 55                      # Magic
83                         # CMD_SET_DAC
8C 80 00 00                # Length = 32780 (0x808C, uint32)
                           #   = 32768 bytes MONO + 12 bytes name
[32768 bytes]              # int16[] MONO (16384 samples)
"tACS 640Hz\0"             # Preset name (–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª–∏–Ω–∞)
XX XX                      # CRC16
```

**–§–æ—Ä–º–∞—Ç payload:**
```
[int16_t buffer[SIGNAL_SAMPLES]] + [char preset_name[]]
  ^--- –ú–û–ù–û (—Ç–æ–ª—å–∫–æ –ø—Ä–∞–≤—ã–π –∫–∞–Ω–∞–ª)    ^--- –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª–∏–Ω–∞
  32768 bytes (16384 samples)
```

**–í–∞–∂–Ω–æ:** 
- –õ–µ–≤—ã–π –∫–∞–Ω–∞–ª = –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ (-0.5V), –Ω–µ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è!
- –ü—Ä–µ—Å–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ SPIFFS –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ

### 3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å gain (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Å–∏–ª–µ–Ω–∏—è)

**–û—Ç–ø—Ä–∞–≤–∫–∞ (Host ‚Üí ESP32):**
```
AA 55                # Magic
88                   # CMD_SET_GAIN
04 00 00 00          # Length = 4 (uint32)
XX XX XX XX          # float32 gain (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1.5)
XX XX                # CRC16
```

**–û—Ç–≤–µ—Ç (ESP32 ‚Üí Host):**
```
AA 55                # Magic
04                   # MSG_ACK
00 00 00 00          # Length = 0 (uint32)
XX XX                # CRC16
```

**–ü—Ä–∏–º–µ—Ä:** –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å gain = 2.0 (—É–¥–≤–æ–∏—Ç—å –∞–º–ø–ª–∏—Ç—É–¥—É)
- Payload: `00 00 00 40` (2.0 –≤ float32 little-endian)

### 4. –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π gain

**–û—Ç–ø—Ä–∞–≤–∫–∞ (Host ‚Üí ESP32):**
```
AA 55                # Magic
89                   # CMD_GET_GAIN
00 00 00 00          # Length = 0 (uint32)
XX XX                # CRC16
```

**–û—Ç–≤–µ—Ç (ESP32 ‚Üí Host):**
```
AA 55          # Magic
04             # MSG_ACK
04 00          # Length = 4
XX XX XX XX    # float32 current gain
XX XX          # CRC16
```

### 5. –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–ª–æ–≥)

**ESP32 ‚Üí Host:**
```
AA 55               # Magic
01                  # MSG_TEXT
10 00               # Length = 16
"WARN: test\n"      # Payload
XX XX               # CRC16
```

## Python –ø—Ä–∏–º–µ—Ä

```python
from test_device import tRNSDevice
import numpy as np

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
dev = tRNSDevice('/dev/ttyACM0')

# –ü–æ–ª—É—á–∏—Ç—å ADC –¥–∞–Ω–Ω—ã–µ
adc_data = dev.get_adc_data()

# –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å (—Å –∏–º–µ–Ω–µ–º –ø—Ä–µ—Å–µ—Ç–∞ –∏ gain)
status = dev.get_status()
print(f"Preset: {status['preset_name']}")
print(f"Gain: {status['gain']}")

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å gain (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Å–∏–ª–µ–Ω–∏—è)
dev.set_gain(1.5)  # –£–≤–µ–ª–∏—á–∏—Ç—å –∞–º–ø–ª–∏—Ç—É–¥—É –≤ 1.5 —Ä–∞–∑–∞

# –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π gain
gain = dev.get_gain()
print(f"Current gain: {gain}")

# –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–µ—Å–µ—Ç (–ú–û–ù–û –±—É—Ñ–µ—Ä + –∏–º—è)
buffer = np.sin(2 * np.pi * 640 * np.arange(16000) / 8000)
buffer = (buffer * 10000).astype(np.int16)  # –ú–û–ù–û!
dev.upload_dac_buffer(buffer, "tACS 640Hz custom")
```

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- **–ë–∏–Ω–∞—Ä–Ω—ã–π** - —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö (80 KB ADC)
- **Magic bytes** - –Ω–∞–¥—ë–∂–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- **CRC16** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
- **–ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–π** - –Ω–µ –º–µ—à–∞–µ—Ç —Ä–∞–±–æ—Ç–µ DMA –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
- **–ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥** - state machine –¥–ª—è –ø—Ä–∏—ë–º–∞
- **–ß–∏—Ç–∞–µ–º—ã–µ –ª–æ–≥–∏** - —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞

### üéØ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- –°–∫–æ—Ä–æ—Å—Ç—å: **921600 baud** ‚âà 92 KB/s —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏
- ADC –±—É—Ñ–µ—Ä (80 KB): **~1 —Å–µ–∫—É–Ω–¥–∞** –ø–µ—Ä–µ–¥–∞—á–∏
- DAC –±—É—Ñ–µ—Ä –ú–û–ù–û (32 KB): **~350 –º—Å** –ø–µ—Ä–µ–¥–∞—á–∏ (–≤–º–µ—Å—Ç–æ 700 –º—Å –¥–ª—è —Å—Ç–µ—Ä–µ–æ!)
- DMA –±—É—Ñ–µ—Ä DAC: **2 —Å–µ–∫** –∑–≤—É–∫–∞ ‚Üí —É—Å–ø–µ–≤–∞–µ—Ç —Å –∑–∞–ø–∞—Å–æ–º!
- –ö–æ–º–∞–Ω–¥—ã: **< 1 –º—Å** (–º–∞–ª—ã–µ –ø–∞–∫–µ—Ç—ã)

**–≠–∫–æ–Ω–æ–º–∏—è:** DAC –ø–µ—Ä–µ–¥–∞—á–∞ **x2 –±—ã—Å—Ç—Ä–µ–µ** (32KB –≤–º–µ—Å—Ç–æ 64KB), —Ç.–∫. –ª–µ–≤—ã–π –∫–∞–Ω–∞–ª = –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞

### üîß Android —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

–î–ª—è Android –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É:
```gradle
implementation 'com.github.mik3y:usb-serial-for-android:3.5.1'
```

–ü—Ä–æ—Ç–æ–∫–æ–ª –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–π - —Ç–µ –∂–µ magic bytes, CRC16, —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.

## –§–∞–π–ª—ã

- `protocol.h/cpp` - –±–∞–∑–æ–≤—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª (–ø–∞—Ä—Å–∏–Ω–≥, CRC)
- `usb_commands.h/cpp` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- `test_device.py` - Python –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

